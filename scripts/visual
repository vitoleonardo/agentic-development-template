#!/bin/sh
#
# Visual Regression Testing Script
#
# This script runs Playwright visual tests for screenshot comparison.
# It detects whether Playwright is configured and provides actionable guidance.
#
# USAGE:
#   ./scripts/visual              # Run all visual tests
#   ./scripts/visual update       # Update snapshots
#   ./scripts/visual --ui         # Run with Playwright UI
#
# SETUP:
#   1. Install Playwright: npm install -D @playwright/test
#   2. Install browsers: npx playwright install
#   3. Create playwright.config.ts (see tests/visual/ for examples)
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Playwright is installed
check_playwright() {
    if [ -f "node_modules/.bin/playwright" ] || [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
        return 0
    fi
    return 1
}

# Check if node_modules exists
check_dependencies() {
    if [ ! -d "node_modules" ]; then
        echo "${YELLOW}Warning: node_modules not found. Run 'npm install' first.${NC}"
        return 1
    fi
    return 0
}

# Print setup instructions
print_setup_instructions() {
    echo "${RED}Playwright visual testing is not configured.${NC}"
    echo ""
    echo "To set up Playwright for visual regression testing:"
    echo ""
    echo "  ${GREEN}1. Install Playwright:${NC}"
    echo "     npm install -D @playwright/test"
    echo ""
    echo "  ${GREEN}2. Install browsers:${NC}"
    echo "     npx playwright install"
    echo ""
    echo "  ${GREEN}3. Create playwright.config.ts:${NC}"
    echo "     See tests/visual/visual-testing.config.ts for recommended settings"
    echo ""
    echo "  ${GREEN}4. Example test files are in:${NC}"
    echo "     tests/visual/example-visual.spec.ts"
    echo ""
    echo "  ${GREEN}5. After setup, run:${NC}"
    echo "     npm run visual"
    echo ""
    echo "For more information:"
    echo "  https://playwright.dev/docs/test-snapshots"
    echo ""
}

# Create minimal playwright config if needed
suggest_config() {
    if [ ! -f "playwright.config.ts" ] && [ ! -f "playwright.config.js" ]; then
        echo "${YELLOW}Tip: No playwright.config.ts found.${NC}"
        echo "Create one with this minimal config:"
        echo ""
        echo "  import { defineConfig } from '@playwright/test';"
        echo "  export default defineConfig({"
        echo "    testDir: './tests/visual',"
        echo "    snapshotDir: './tests/visual/snapshots',"
        echo "    use: { baseURL: 'http://localhost:3000' },"
        echo "  });"
        echo ""
    fi
}

# Main execution
main() {
    if ! check_playwright; then
        print_setup_instructions
        exit 1
    fi

    if ! check_dependencies; then
        exit 1
    fi

    suggest_config

    # Parse command
    case "${1:-}" in
        update)
            echo "${GREEN}Updating visual snapshots...${NC}"
            npx playwright test tests/visual/ --update-snapshots
            ;;
        --ui)
            echo "${GREEN}Starting Playwright UI...${NC}"
            npx playwright test tests/visual/ --ui
            ;;
        --report)
            echo "${GREEN}Opening test report...${NC}"
            npx playwright show-report
            ;;
        "")
            echo "${GREEN}Running visual regression tests...${NC}"
            npx playwright test tests/visual/
            ;;
        *)
            # Pass through any other arguments to playwright
            echo "${GREEN}Running Playwright with custom args...${NC}"
            npx playwright test tests/visual/ "$@"
            ;;
    esac
}

main "$@"
